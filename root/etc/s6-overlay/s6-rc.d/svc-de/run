#!/usr/bin/with-contenv bash

# wait for X to be running
while true; do
  if xset q &>/dev/null; then
    break
  fi
  sleep .5
done

# set resolution before starting apps
# Use environment variables if set, otherwise default to 1024x768
RESOLUTION_WIDTH=${SELKIES_MANUAL_WIDTH:-1024}
RESOLUTION_HEIGHT=${SELKIES_MANUAL_HEIGHT:-768}
RESOLUTION="${RESOLUTION_WIDTH}x${RESOLUTION_HEIGHT}"

# Generate modeline using cvt
MODELINE=$(s6-setuidgid abc cvt ${RESOLUTION_WIDTH} ${RESOLUTION_HEIGHT} | grep "Modeline" | sed 's/^.*Modeline //')
MODELINE_NAME=$(echo "$MODELINE" | cut -d' ' -f1 | tr -d '"')
MODELINE_PARAMS=$(echo "$MODELINE" | cut -d' ' -f2-)

if ! s6-setuidgid abc xrandr | grep -q "$RESOLUTION"; then
  s6-setuidgid abc xrandr --newmode $MODELINE
  s6-setuidgid abc xrandr --addmode screen "$MODELINE_NAME"
  s6-setuidgid abc xrandr --output screen --mode "$MODELINE_NAME" --dpi 96
fi

# set xresources
if [ -f "${HOME}/.Xresources" ]; then
  xrdb "${HOME}/.Xresources"
else
  echo "Xcursor.theme: breeze" > "${HOME}/.Xresources"
  xrdb "${HOME}/.Xresources"
fi
chown abc:abc "${HOME}/.Xresources"
chmod 777 /tmp/selkies*

# run
cd $HOME
exec s6-setuidgid abc \
  /bin/bash /defaults/startwm.sh &
PID=$!
echo "$PID" > /de-pid
wait "$PID"
